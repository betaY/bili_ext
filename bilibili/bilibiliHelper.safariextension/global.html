<!DOCTYPE HTML>
<script>
// Register for the validate and command events.
safari.application.addEventListener("command", performCommand, true);
safari.application.addEventListener("validate", validateCommand, true);
safari.application.addEventListener("menu", menuHandler, true);

function performCommand(event)
{
	var newTab;
	if (event.command != "bilibili-helper")
		return;

	// Close others tab except the current one in the target's window.
    var win = event.target.browserWindow;
    var myTabs = win.tabs;
    var bili_url = 'http://www.bilibili.com/';
    // if (myTabs.length == 0) {
    // 	newTab = win.openTab().url = bili_url;
    // 	// alert("Hello World!");
    // }
    // var url = win.activeTab.url;
    // alert(safari.application.activeBrowserWindow.activeTab.url);
    // alert(String(win.activeTab.url));
    for (var i = 0; i < myTabs.length; ++i) {
        var tab = myTabs[i];
        // newTab = win.openTab()
         // newTab = win.openTab().url = bili_url;
        // alert(tab.url+"\n"+bili_url+"\n");
        // alert(tab.url.match(/www\.bilibili\.com/gi) == 'www.bilibili.com');
        // safari.application.activeBrowserWindoasdw.activeTab.url

        // if (tab.url.localeCompare(bili_url) == 0){
        if (tab.url.match(/www\.bilibili\.com/gi) == 'www.bilibili.com') {
            //do nothing for current tab
            // var newTab;
            // alert("Enter")
            // newTab = win.openTab().url = 'http://www.bilibili.com';
            // win.activeTab = tab;
            tab.activate();
            // break;
        }else if (i == myTabs.length-1){
            newTab = win.openTab().url = bili_url;
        } else {
            // tab.close();
            // newTab = win.openTab().url = bili_url;
        }
    }
}

function validateCommand(event)
{
	if (event.command !== "bilibili-helper")
		return;
}

function menuHandler(event) {
    if (event.command !== "goto-bilibili") {
        return;
    }
}
</script>